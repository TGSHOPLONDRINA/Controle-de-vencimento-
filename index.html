<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Vencimentos - Casa de Ra칞칚o</title>
<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#fff; margin:0; padding:20px; }
h1 { text-align:center; margin-bottom:20px; color:#38bdf8; }
.card { background:#1e293b; border-radius:12px; padding:20px; margin:0 auto 30px auto; max-width:950px; box-shadow:0 4px 12px rgba(0,0,0,0.5); }
label { display:block; margin-bottom:5px; font-weight:bold; }
input, select { width:100%; padding:8px; margin-bottom:15px; border:none; border-radius:8px; }
button { padding:10px; border:none; border-radius:8px; background:#38bdf8; color:#000; font-weight:bold; cursor:pointer; margin-top:5px; }
button:hover { background:#0ea5e9; }
.btn-remover { background:#ef4444; color:white; padding:5px 10px; border-radius:6px; cursor:pointer; border:none; }
.btn-remover:hover { background:#dc2626; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { padding:10px; text-align:center; }
th { background:#334155; }
tr:nth-child(even) { background:#1e293b; }
.alerta-vermelho { background: rgba(239,68,68,0.5) !important; animation: piscar 1s infinite alternate; }
.alerta-amarelo { background: rgba(234,179,8,0.5) !important; }
@keyframes piscar { from { background-color: rgba(239,68,68,0.3); } to { background-color: rgba(239,68,68,0.8); } }
.resumo { display:flex; justify-content:space-around; text-align:center; margin-bottom:20px; }
.resumo div { background:#334155; padding:15px; border-radius:10px; flex:1; margin:5px; }
#scanner { width:100%; max-width:400px; margin:10px auto; }
@media(max-width:600px) { .resumo{flex-direction:column;} }
</style>
</head>
<body>
<h1>Controle de Vencimentos - Casa de Ra칞칚o</h1>

<!-- Resumo -->
<div class="resumo">
  <div><strong id="resumoHoje">0</strong><br>Vencem Hoje</div>
  <div><strong id="resumoSemana">0</strong><br>Vencem na Semana</div>
  <div><strong id="resumoVencidos">0</strong><br>J치 Vencidos</div>
</div>

<!-- Cadastro -->
<div class="card">
  <label>Produto</label>
  <input type="text" id="produto" placeholder="Ex: Ra칞칚o Premium 15kg">

  <label>C칩digo/Barra</label>
  <input type="text" id="codigo" placeholder="Ex: 1234567890123">
  <button onclick="iniciarScanner()">游닝 Escanear C칩digo</button>
  <div id="scanner"></div>

  <label>Categoria</label>
  <select id="categoria">
    <option value="">Selecione</option>
    <option>Cachorro</option>
    <option>Gato</option>
    <option>Aves</option>
    <option>Peixes</option>
    <option>Roedores/Coelhos</option>
    <option>Cavalos</option>
    <option>Bovinos</option>
    <option>Su칤nos</option>
    <option>Sementes & Gr칚os</option>
    <option>Higiene & Acess칩rios</option>
    <option>Outra</option>
  </select>

  <label>Validade</label>
  <input type="date" id="validade">

  <label>Quantidade</label>
  <input type="number" id="quantidade" placeholder="Ex: 10">

  <button onclick="adicionarProduto()">Adicionar Produto</button>
</div>

<!-- Busca + Filtro + Exportar -->
<div class="card">
  <input type="text" id="busca" placeholder="游댌 Buscar produto ou c칩digo..." onkeyup="filtrarProdutos()">

  <label>Filtrar por Categoria</label>
  <select id="filtroCategoria" onchange="filtrarProdutos()">
    <option value="">Todas</option>
    <option>Cachorro</option>
    <option>Gato</option>
    <option>Aves</option>
    <option>Peixes</option>
    <option>Roedores/Coelhos</option>
    <option>Cavalos</option>
    <option>Bovinos</option>
    <option>Su칤nos</option>
    <option>Sementes & Gr칚os</option>
    <option>Higiene & Acess칩rios</option>
    <option>Outra</option>
  </select>

  <button onclick="exportarCSV()">游닋 Exportar CSV</button>
</div>

<!-- Tabela -->
<div class="card">
  <table id="tabela">
    <thead>
      <tr>
        <th>Produto</th>
        <th>C칩digo</th>
        <th>Categoria</th>
        <th>Validade</th>
        <th>Dias Restantes</th>
        <th>Quantidade</th>
        <th>A칞칫es</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="7">Nenhum produto cadastrado.</td></tr>
    </tbody>
  </table>
</div>

<!-- QuaggaJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
const tabela = document.querySelector("#tabela tbody");
let produtos = [];

function carregarProdutos() {
  const dados = localStorage.getItem("produtos");
  if(dados){ produtos = JSON.parse(dados); atualizarTabela(); }
}

function salvarProdutos() {
  localStorage.setItem("produtos", JSON.stringify(produtos));
}

function calcularDiasRestantes(validade){
  const hoje = new Date();
  const expira = new Date(validade);
  const diff = expira - hoje;
  return Math.ceil(diff / (1000*60*60*24));
}

function adicionarProduto(){
  const nome = document.getElementById("produto").value;
  const codigo = document.getElementById("codigo").value;
  const categoria = document.getElementById("categoria").value;
  const validade = document.getElementById("validade").value;
  const quantidade = document.getElementById("quantidade").value;

  if(!nome || !validade || !categoria || !codigo){ alert("Preencha todos os campos!"); return; }

  const produto = { id: Date.now(), nome, codigo, categoria, validade, quantidade };
  produtos.push(produto);
  salvarProdutos();
  atualizarTabela();

  document.getElementById("produto").value="";
  document.getElementById("codigo").value="";
  document.getElementById("categoria").value="";
  document.getElementById("validade").value="";
  document.getElementById("quantidade").value="";
}

function removerProduto(id){
  produtos = produtos.filter(p => p.id !== id);
  salvarProdutos();
  atualizarTabela();
}

function atualizarTabela(){
  tabela.innerHTML = "";
  if(produtos.length===0){ tabela.innerHTML='<tr><td colspan="7">Nenhum produto cadastrado.</td></tr>'; atualizarResumo(); return; }

  produtos.sort((a,b)=>new Date(a.validade)-new Date(b.validade));

  produtos.forEach(p=>{
    const dias = calcularDiasRestantes(p.validade);
    let classe = "";
    if(dias<0) classe="alerta-vermelho";
    else if(dias<=3) classe="alerta-vermelho";
    else if(dias<=7) classe="alerta-amarelo";

    const tr=document.createElement("tr");
    tr.className=classe;
    tr.innerHTML=`
      <td>${p.nome}</td>
      <td>${p.codigo}</td>
      <td>${p.categoria}</td>
      <td>${new Date(p.validade).toLocaleDateString("pt-BR")}</td>
      <td>${dias<0?"丘멆잺 Vencido":dias+" dias"}</td>
      <td>${p.quantidade}</td>
      <td><button class="btn-remover" onclick="removerProduto(${p.id})">Remover</button></td>
    `;
    tabela.appendChild(tr);
  });

  atualizarResumo();
  filtrarProdutos();
}

function atualizarResumo(){
  let hojeCount=0, semanaCount=0, vencidos=0;
  produtos.forEach(p=>{
    const dias=calcularDiasRestantes(p.validade);
    if(dias===0) hojeCount++;
    if(dias>0 && dias<=7) semanaCount++;
    if(dias<0) vencidos++;
  });
  document.getElementById("resumoHoje").innerText=hojeCount;
  document.getElementById("resumoSemana").innerText=semanaCount;
  document.getElementById("resumoVencidos").innerText=vencidos;
}

function filtrarProdutos(){
  const termo=document.getElementById("busca").value.toLowerCase();
  const filtroCat=document.getElementById("filtroCategoria").value;
  const linhas=document.querySelectorAll("#tabela tbody tr");
  linhas.forEach(linha=>{
    const cols=linha.querySelectorAll("td");
    if(cols.length>0){
      const nome=cols[0].innerText.toLowerCase();
      const codigo=cols[1].innerText.toLowerCase();
      const categoria=cols[2].innerText;
      const matchNome = nome.includes(termo) || codigo.includes(termo);
      const matchCat = filtroCat===""||categoria===filtroCat;
      linha.style.display = matchNome && matchCat ? "" : "none";
    }
  });
}

function exportarCSV(){
  if(produtos.length===0){ alert("Nenhum produto para exportar!"); return; }
  let csv="Produto;C칩digo;Categoria;Validade;Dias Restantes;Quantidade\n";
  produtos.forEach(p=>{
    const dias=calcularDiasRestantes(p.validade);
    csv+=`${p.nome};${p.codigo};${p.categoria};${new Date(p.validade).toLocaleDateString("pt-BR")};${dias} dias;${p.quantidade}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="controle_vencimentos.csv";
  link.click();
}

// Scanner de c칩digo de barras usando QuaggaJS
function iniciarScanner() {
  const scannerDiv = document.getElementById('scanner');
  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: scannerDiv,
      constraints: { facingMode: "environment" }
    },
    decoder: { readers: ["code_128_reader","ean_reader","ean_8_reader"] }
  }, function(err) {
    if(err) { console.error(err); alert("Erro ao acessar a c칙mera"); return; }
    Quagga.start();
  });

  Quagga.onDetected(function(result) {
    const codigo = result.codeResult.code;
    document.getElementById('codigo').value = codigo;
    Quagga.stop();
    scannerDiv.innerHTML = "";
    alert("C칩digo detectado: " + codigo);
  });
}

carregarProdutos();
</script>
</body>
</html>
